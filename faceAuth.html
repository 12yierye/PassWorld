<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PassWorld - Face Authentication</title>
  <link rel="stylesheet" href="css/global.css" />
  <link rel="stylesheet" href="css/login.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>PassWorld</h1>
      <div id="user-info">验证中</div>
    </header>

    <div id="auth-section" class="auth-section">
      <h2 id="auth-title">人脸识别验证</h2>
      <div id="error-message" class="error-message"></div>
      <div id="success-message" class="success-message"></div>
      <div class="face-auth-container">
        <div id="camera-section">
          <p id="verification-message">正在进行人脸识别验证...</p>
          <div id="video-container" class="hidden">
            <video id="video" width="300" height="250" autoplay muted></video>
          </div>
          <div id="face-id-processing" class="face-id-processing">
            <div class="spinner"></div>
            <p>正在扫描面部特征...</p>
            <p>请直视摄像头</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/global.js"></script>
  <script>
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    const action = urlParams.get('action'); // 'login' or 'register'
    
    // 根据操作类型设置标题和消息
    if (action === 'register') {
      document.getElementById('auth-title').textContent = '身份验证';
      document.getElementById('verification-message').textContent = '正在验证身份...';
    }
    
    // 设置用户信息显示
    if (username) {
      document.getElementById('user-info').textContent = `验证: ${username}`;
    }

    // 模拟人脸识别验证过程，现在是2.3秒
    setTimeout(async () => {
      try {
        // 模拟人脸识别验证
        if (action === 'login') {
          // 对于登录，检查用户是否存在
          const { ipcRenderer } = require('electron');
          const result = await ipcRenderer.invoke('db-check-user', username);
          
          if (result.exists) {
            // 设置当前用户并跳转到主页面
            window.PassWorld.loginUser(username, 'temp_password');
            window.location.href = 'mainPage.html';
          } else {
            document.getElementById('error-message').textContent = '用户不存在';
            document.getElementById('error-message').style.display = 'block';
            
            // 2秒后返回登录页
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 2000);
          }
        } else if (action === 'register') {
          // 对于注册，验证成功后跳转回登录页面
          document.getElementById('success-message').textContent = '验证成功！请返回登录';
          document.getElementById('success-message').style.display = 'block';
          
          // 注册验证成功后，显示成功信息并2秒后跳转到登录页面
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        }
      } catch (error) {
        document.getElementById('error-message').textContent = '验证失败: ' + error.message;
        document.getElementById('error-message').style.display = 'block';
        
        // 2秒后返回相应页面
        setTimeout(() => {
          if (action === 'register') {
            window.location.href = 'register.html';
          } else {
            window.location.href = 'login.html';
          }
        }, 2000);
      }
    }, 2300); // 2.3秒后完成验证
  </script>
</body>
</html>